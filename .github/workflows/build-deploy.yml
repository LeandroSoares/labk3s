name: Build and Deploy Joke App

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/build-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
  # Permite execu√ß√£o manual do workflow
  workflow_dispatch:

env:
  VERSION: ${{ github.sha }}

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./src/frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/joke-frontend:${{ env.VERSION }},${{ secrets.DOCKERHUB_USERNAME }}/joke-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/joke-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/joke-frontend:buildcache,mode=max
          
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/joke-frontend:${{ env.VERSION }}
          format: 'sarif'
          output: 'trivy-results-frontend.sarif'
          exit-code: '0'  # N√£o falha a pipeline, apenas reporta
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results-frontend.sarif'
          category: 'frontend-vulnerabilities'

  build-backend:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./src/backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/joke-backend:${{ env.VERSION }},${{ secrets.DOCKERHUB_USERNAME }}/joke-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/joke-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/joke-backend:buildcache,mode=max
          
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/joke-backend:${{ env.VERSION }}
          format: 'sarif'
          output: 'trivy-results-backend.sarif'
          exit-code: '0'  # N√£o falha a pipeline, apenas reporta
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results-backend.sarif'
          category: 'backend-vulnerabilities'

  # Gerar relat√≥rio de seguran√ßa
  security-report:
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Generate Security Report
        run: |
          echo "## üîí Relat√≥rio de Seguran√ßa das Imagens Docker" > security-report.md
          echo "### ‚ö†Ô∏è Este relat√≥rio mostra as vulnerabilidades encontradas nas imagens de cont√™iner" >> security-report.md
          echo "#### Imagens analisadas:" >> security-report.md
          echo "- Frontend: \`${{ secrets.DOCKERHUB_USERNAME }}/joke-frontend:${{ env.VERSION }}\`" >> security-report.md
          echo "- Backend: \`${{ secrets.DOCKERHUB_USERNAME }}/joke-backend:${{ env.VERSION }}\`" >> security-report.md
          echo "" >> security-report.md
          echo "Para ver detalhes completos, verifique a aba 'Security' do reposit√≥rio." >> security-report.md
          
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md

  # Deploy para o Kubernetes
  deploy:
    needs: [build-frontend, build-backend, security-report]
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # Verificar se consegue conectar ao cluster (diagn√≥stico)
          echo "Verificando conex√£o com o cluster..."
          kubectl cluster-info

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1
      
      - name: Update Kubernetes manifests
        run: |
          # Substitui as vari√°veis nos arquivos YAML
          sed -i "s|\${DOCKER_USERNAME}|${{ secrets.DOCKERHUB_USERNAME }}|g" ./k8s/app/frontend.yaml
          sed -i "s|\${VERSION}|${{ env.VERSION }}|g" ./k8s/app/frontend.yaml
          sed -i "s|\${DOCKER_USERNAME}|${{ secrets.DOCKERHUB_USERNAME }}|g" ./k8s/app/backend.yaml
          sed -i "s|\${VERSION}|${{ env.VERSION }}|g" ./k8s/app/backend.yaml
       
      - name: Deploy to Kubernetes
        run: |
          # Exibir os arquivos que ser√£o aplicados
          echo "Arquivos a serem aplicados:"
          ls -la k8s/app/
          
          # Aplicar todos os recursos usando kustomize
          kubectl apply -k k8s/app/ --validate=true
          
          # Verificar status do deployment
          echo "Aguardando deployments..."
          kubectl rollout status deployment/backend -n joke-app --timeout=180s
          kubectl rollout status deployment/frontend -n joke-app --timeout=180s
          
          echo "Aplica√ß√£o implantada com sucesso em www.labk3s.online"
          
          # Mostrar informa√ß√µes sobre os deployments
          echo "Informa√ß√µes dos deployments:"
          kubectl get deployments -n joke-app
          kubectl get pods -n joke-app
